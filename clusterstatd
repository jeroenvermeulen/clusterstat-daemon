#!/usr/bin/php -q
<?php
try {
    // prepare environment
    require 'includes/bootstrap.php';

    // daemonize the script
    Daemonizer::daemonize();
    Log::info('Cluster statistics daemon started');

    // initialize webserver
    $webserver = new Webserver();
    $webserver->setCredentials(Config::get('http_username'), Config::get('http_password'));
    $webserver->setRoot(APP_ROOT . 'web');

    // initialize cluster statistics collection
    $stats = new ClusterStats();
    $procstats = new ProcStats();

    $stats->setProcStats( $procstats );

    $webserver->registerController('/', array($stats, 'homepage'));
    $webserver->registerController('/runtimestats.js', array($stats, 'getRuntimeStats'));
    $webserver->registerController('/procstats_json', array($procstats, 'getJsonProcStats'), 'application/json' );
    $webserver->registerController('/procstats_cacti', array($procstats, 'getCactiProcStats'), 'text/plain' );
    $webserver->registerController('/procstats_nagios', array($procstats, 'getNagiosProcStats'), 'text/plain' );
    $webserver->registerController('/procstats_detail_html', array($procstats, 'getProcStatsDetailHtml'), 'text/html' );

    // register timers
    $timer = new Timer();
    $timer->register(array('Log','rotate'), 30);

    $timer->register(array($procstats,'collectProcStats'), 1, true);
    $timer->register(array($procstats,'writeDatabase'), 300, false);

    // enter main application loop
    for(;;) {
        $webserver->handleClients(250000);

        // dispatch pending timer and system signals
        $timer->checkTimers();
        pcntl_signal_dispatch();
    }
} catch(Exception $e) {
    Log::error('Fatal '.get_class($e).': '.$e->getMessage());
    exit($e->getCode());
}
